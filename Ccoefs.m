function [ C ] = Ccoefs(  eta , h , etx , hx ,etxx ,hxx,mi0 , h0 , k ,kx,kxx,  A,Nm)

a = (mi0*h0+1)/2/h0;
b = (mi0*h0-1)/2/h0;
H = eta+h;
Hx = etx+hx;
Hxx = etxx+hxx;

C(1,1,:) = 2*a - 4*(a^2)*H./3  + (2*a - 4*a*a*H/3).*hx.^2 +...
           (-2*a + a*a*H - a*(1-a*H)).*hx.*Hx + ...
           (2*a/3 - 4*a*a*H/15).*Hx.^2 +... 
           (a*H - 0.5*a*a*H.^2).*hxx + (-4*a*H/3 +4*a*a*H.*H/5).*Hxx;
       
C(1,2,:) = 2*b - 4*(a*b)*H./3  + (1-a*H)./h0 + (2*b - (4*(a*b)*H)./3 + (1-a*H)./h0).*hx.^2 +...
           (-2*b + a*b*H - a*(1-a*H)).*hx.*Hx + ...
           (2*b/3 - 4*a*b*H./15).*Hx.^2 +... 
           (b*H - 0.5*a*b*H.^2 + H/h0 - 2*a*H.*H/3/h0).*hxx + (-a*H - b*H/3 +2*a*a*H.*H/3 +2*a*b.*H.*H./15).*Hxx;    
       
C(2,1,:) = 2*a + H.*(-2*a^2 + (2*a*b/3) +(a/h0)) + ( 2*a  + H.*(-2*a^2 +(2*a*b/3) +a/h0) ).*hx.^2 +...
           ( -3*a + H.*(3*a*a - a*b - 4*a/3/h0) ).*hx.*Hx + ...
           ((2*a/3) + H.*(-(2*a*a/3) + 2*(a*b/5) +a/2/h0)).*Hx.^2 +... 
           (a*H + a*H.*H.*(40-60*a*h0 +30*b*h0)/60/h0).*hxx +...
           (-4*a*H/3 + a*H.*H.*(-45+80*a*h0 - 32*b*h0)/60/h0).*Hxx;  
% 
C(2,2,:) = 2*b + H.*(-2*a*b + 2*b*b/3 -a/h0 +b/h0)+(1/h0) + (2*b  + H.*(-2*a*b +2*b*b/3 -a/h0 +b/h0) +1/h0).*hx.^2 +...
           (-a-2*b + H.*(a^2+2*a*b-b^2 - 4*b/3/h0)).*hx.*Hx + ...
           (2*b/3 + H.*(-2*a*b/3 + 2*b*b/5 +b/2/h0)).*Hx.^2 +... 
           (H.*(b + 1/h0) + (H.^2).*(-a*b + (b^2)/2 + 1./(2*h0^2) - a/h0 + b/h0)).*hxx +...
           ((-a - b/3)*H + (H.^2).*(a^2 - (b^2)/5 - a/(2*h0) - b/(4*h0))).*Hxx;         

k0 = k(:,1);

C(3,1,:) = ((2*a)./(H.*k0.^2) - (2*a*mi0)./((H.^2).*(k0.^4)) - (2*a*mi0)./k0.^2).*Hxx + ...
            ((4*a./(H.*H.*k0.^2))-(4*a*mi0./H./k0.^2) - (a+(4*a./(H.*H.*k0.^2))).*sech(k0.*H)).*Hx.*hx + ...
            (-((4*a)./((H.^2).*(k0.^2))) + ((4*a*mi0)./((H.^3).*(k0.^4))) + (2*a*mi0)./(H.*k0.^2)).*Hx.^2 + ...
            (2*a*mi0./H./k0.^2).*hx.^2 + ...
            ( ((2*a*mi0)./k0.^2) + ((2*a*(-k0 + k0.*sech(H.*k0)))./(H.*k0.^3))).*hxx+...
            (2*a*mi0)./(H.*k0.^2);

C(3,2,:) = (((2*b)./(H.*k0.^2)) - (2*b*mi0)./((H.^2).*(k0.^4)) - ((a+b)*mi0)./k0.^2).*Hxx + ...
            ((4*b./(H.*H.*k0.^2))-(4*b*mi0./H./k0.^2) - (a+(4*b./(H.*H.*k0.^2))).*sech(k0.*H)).*Hx.*hx + ...
            (-((4*b)./((H.^2).*(k0.^2))) + (4*b*mi0)./((H.^3).*(k0.^4)) + (2*b*mi0)./(H.*k0.^2) ).*Hx.^2 + ...
            ((2*b*mi0./H./k0.^2) + (sech(k0.*H)/h0)).*hx.^2 + ...
            ( -((2*b)./(H.*k0.^2)) + (2*b*mi0)./k0.^2 + mi0./(h0*k0.^2) + (2*b*sech(H.*k0))./(H.*k0.^2)).*hxx+...
            ((2*b*mi0)./(H.*k0.^2))+sech(k0.*H)/h0;  

k0x = kx(:,1);
k0xx = kxx(:,1);

C0 = (mi0./k0).*(k0x.*H+k0.*Hx);
C0x = mi0*( (k0xx.*H + 2.*k0x.*Hx + k0.*Hxx).*k0 -(k0x.*H+k0.*Hx).*k0x )./k0.^2 ;
        
C(1,3,:) = squeeze(A(1,3,:)).*(-C0x + k0.^2)+... 
           (hx.^2).*(-2*a + mi0 + (2*a*mi0)./(H.*k0.^2))+...
           (C0.^2).*((2*a*mi0)./(H.*k0.^4) + (-2*a + mi0)./k0.^2) +...
           (k0x.^2).*( (24*a*mi0)./(H.*k0.^6) + (-24*a + 2*mi0 + 10*a*H*mi0)./k0.^4 +...
           (-2*H + (H.^2).*(-2*a + mi0))./k0.^2) + ...
           k0xx.*(H./k0 - (6*a*mi0)./(H.*k0.^5) + (6*a - mi0 - 2*a*H*mi0)./k0.^3) + ...
           C0.*k0x.*(-((2*H)./k0) + (12*a*mi0)./(H.*k0.^5) + (-12*a + 2*mi0 + 4*a*H*mi0)./k0.^3)+...
           hxx.*( 1 + (2*a)./(H.*k0.^2) - (2*a*mi0)./k0.^2 + (-1 + a*H - (2*a)./(H.*k0.^2)).*sech(H.*k0) ) + ...
           C0.*hx.*(-2 + (-((4*a)./H) + 4*a*mi0)./k0.^2 + (1 - a*H + (4*a)./(H.*k0.^2)).*sech(H.*k0))+...
           hx.*k0x.*((H.*(-4*a + 2*mi0))./k0 + (-((8*a)./H) + 8*a*mi0)./k0.^3 +...
           (8*a*sech(H.*k0))./(H.*k0.^3));

C(2,3,:) = squeeze(A(2,3,:)).*(-C0x + k0.^2) +... 
            (hx.^2).*( -2*b - 1/h0 + mi0 + (2*b*mi0)./(H.*k0.^2) +H.*(-a*mi0 + b*mi0 +mi0/h0)+sech(k0.*H)/h0 )+...
            (C0.^2).*( (2*b*mi0)./(H.*k0.^4) + (-2*b - 1/h0 + mi0 + H.*(-a*mi0 + b*mi0 + mi0/h0) + sech(H.*k0)/h0)./k0.^2 )+...
            (k0x.^2).*( (24*b*mi0)./(H.*k0.^6) + (-2*H + (H.^2).*(2*a - 4*b - 3/h0 + mi0) +... 
                        (H.^3).*(-a*mi0 + b*mi0 + mi0/h0))./k0.^2 + (-24*b - 6/h0 + 2*mi0 + H.*(-2*a*mi0 + 12*b*mi0 + (6*mi0)/h0) + (6*sech(H.*k0))/h0)./k0.^4  )+ ...
             k0xx.*((H + (H.^2).*(-a + b + 1/h0))./k0 - (6*b*mi0)./(H.*k0.^5) + (6*b + 2/h0 - mi0 + H.*(a*mi0 - 3*b*mi0 - (2*mi0)/h0) - (2*sech(H.*k0))/h0)./k0.^3)+ ...
            C0.*k0x.*((-2*H + (H.^2).*(2*a - 2*b - 2/h0))./k0 + (12*b*mi0)./(H.*k0.^5) + (-12*b - 4/h0 + 2*mi0 + H.*(-a*mi0 + 3*b*mi0 + (2*mi0)/h0 + ((2 - a*h0 + 3*b*h0)*mi0)/h0) +...
                    (4*sech(H.*k0))/h0)./k0.^3) +...
             hxx.*( 1 - a*H + b*H + H/h0 + (-1 + a*H).*sech(H.*k0) + ((2*b)./H - 2*b*mi0 - mi0/h0 - (2*b*sech(H.*k0))./H)./k0.^2 ) + ...
             C0.*hx.*(-2 + H.*(2*a - 2*b - 2/h0) + (1 - a*H).*sech(H.*k0) + (-((4*b)./H) +... 
              4*b*mi0 + (2*mi0)/h0 + (4*b*sech(H.*k0))./H)./k0.^2)+...
             hx.*k0x.*((H.*(-4*b - 2/h0 + 2*mi0) +... 
                    (H.^2).*(-2*a*mi0 + 2*b*mi0 + (2*mi0)/h0))./k0 + (-((8*b)./H) +... 
                    8*b*mi0 + (2*mi0)/h0 + (8*b*sech(H.*k0))./H)./k0.^3);
%                     
           
C(3,3,:) = squeeze(A(3,3,:)).*(-C0x + k0.^2) +... 
            (hx.^2).*( (H.*k0.^2)/2 + mi0/2 - (H.*mi0^2)/2 )+...
            (C0.^2).*( H/2 + (mi0/2 - (H*mi0^2)/2)./k0.^2 )+...
            (k0x.^2).*( (H.^3)/6 + (mi0/4 - (H.*mi0^2)/4)./k0.^4 + (-(H/4) + ((H.^2).*mi0)/2 -...
            ((H.^3)*mi0^2)/6)./k0.^2 )+ ...
             k0xx.*(H./(4*k0) + (-(mi0/4) + (H.*mi0^2)/4)./k0.^3) +...
             hxx.*( (mi0^2)./(2*k0.^2) ) + ...
             -C0.*hx +... 
             hx.*k0x.*(((H.^2).*k0)/2 + (mi0^2)./(2*k0.^3) + (H.*mi0 - ((H.^2)*mi0^2)/2)./k0)+...
             C0.*k0x.*(-(H./(2*k0)) + (mi0/2 - (H*mi0^2)/2)./k0.^3);         
       

        
        

for n=4:Nm
kn = k(:,n-2);  
knx = kx(:,n-2);
knxx = kxx(:,n-2);

Cn = (mi0./kn).*(knx.*H+kn.*Hx);
Cnx = mi0*( (knxx.*H + 2.*knx.*Hx + kn.*Hxx).*kn -(knx.*H+kn.*Hx).*knx )./kn.^2 ;



C(n,1,:) = (-(2*a)./(H.*kn.^2) - (2*a*mi0)./((H.^2).*(kn.^4)) + (2*a*mi0)./kn.^2).*Hxx + ...
            ((-4*a./(H.*H.*kn.^2))+(4*a*mi0./H./kn.^2) - (a-(4*a./(H.*H.*kn.^2))).*sec(kn.*H)).*Hx.*hx + ...
            (((4*a)./((H.^2).*(kn.^2))) + ((4*a*mi0)./((H.^3).*(kn.^4))) - (2*a*mi0)./(H.*kn.^2)).*Hx.^2 + ...
            (-2*a*mi0./H./kn.^2).*hx.^2 + ...
            ( (-(2*a*mi0)./kn.^2) + ((2*a*(kn - kn.*sec(H.*kn)))./(H.*kn.^3))).*hxx+...
            (-2*a*mi0)./(H.*kn.^2);
            
C(n,2,:) = (((-2*b)./(H.*kn.^2)) - (2*b*mi0)./((H.^2).*(kn.^4)) + ((a+b)*mi0)./kn.^2).*Hxx + ...
            ((-4*b./(H.*H.*kn.^2))+(4*b*mi0./H./kn.^2) - (a-(4*b./(H.*H.*kn.^2))).*sec(kn.*H)).*Hx.*hx + ...
            (((4*b)./((H.^2).*(kn.^2))) + (4*b*mi0)./((H.^3).*(kn.^4)) - (2*b*mi0)./(H.*kn.^2) ).*Hx.^2 + ...
            ((-2*b*mi0./H./kn.^2) + (sec(kn.*H)/h0)).*hx.^2 + ...
            ( ((2*b)./(H.*kn.^2)) - (2*b*mi0)./kn.^2 - mi0./(h0*kn.^2) - (2*b*sec(H.*kn))./(H.*kn.^2)).*hxx+...
            ((-2*b*mi0)./(H.*kn.^2))+sec(kn.*H)/h0;  
        
C(1,n,:) = squeeze(A(1,n,:)).*(-Cnx - kn.^2)+... 
           (hx.^2).*(-2*a + mi0 - (2*a*mi0)./(H.*kn.^2))+...
           (Cn.^2).*((2*a*mi0)./(H.*kn.^4) + (2*a - mi0)./kn.^2) +...
           (knx.^2).*( -(2*H - (H.^2).*(-2*a + mi0))./kn.^2 + (24*a*mi0)./(H.*kn.^6) +...
               (24*a - 2*mi0 - 10*a*H*mi0)./kn.^4) + ...
           knxx.*(H./kn - (6*a*mi0)./(H.*kn.^5) - (6*a - mi0 - 2*a*H*mi0)./kn.^3) + ...
           Cn.*knx.*(-((2*H)./kn) + (12*a*mi0)./(H.*kn.^5) - (-12*a + 2*mi0 + 4*a*H*mi0)./kn.^3)+...
           hxx.*( 1 - (2*a)./(H.*kn.^2) + (2*a*mi0)./kn.^2 + (-1 + a*H + (2*a)./(H.*kn.^2)).*sec(H.*kn) ) + ...
           Cn.*hx.*(-2 + ((4*a)./H - 4*a*mi0)./kn.^2 + (1 - a*H - (4*a)./(H.*kn.^2)).*sec(kn.*H))+...
           hx.*knx.*( (H.*(-4*a + 2*mi0))./kn + (-8*a*mi0 + (8*a - 8*a*sec(H.*kn))./H)./kn.^3);
 
 C(2,n,:) = squeeze(A(2,n,:)).*(-Cnx - kn.^2)+... 
           (hx.^2).*(-2*b + mi0 - 1/h0 - (2*b*mi0)./(H.*kn.^2) + H.*(-a*mi0 + b*mi0 + mi0/h0) + sec(H.*kn)/h0 )+...
           (Cn.^2).*((2*b*mi0)./(H.*kn.^4) + (2*b + 1/h0 - mi0 + H.*(a*mi0 - b*mi0 - mi0/h0) - sec(H.*kn)/h0)./kn.^2) +...
           (knx.^2).*( (24*b*mi0)./(H.*kn.^6) + (-2*H + (H.^2).*(2*a - 4*b - 3/h0 + mi0) + (H.^3).*(-a*mi0 + b*mi0 + mi0/h0))./kn.^2 +...
                  (24*b + 6/h0 - 2*mi0 + H.*(2*a*mi0 - 12*b*mi0 - (6*mi0)/h0) - (6*sec(H.*kn))/h0)./kn.^4) + ...
            knxx.*((H + (H.^2).*(-a + b + 1/h0))./kn - (6*b*mi0)./(H.*kn.^5) + (-6*b - 2/h0 + mi0 + H.*(-a*mi0 + 3*b*mi0 + (2*mi0)/h0) +...
                                                    (2*sec(H.*kn))/h0)./kn.^3)  + ...
           Cn.*knx.*((-2*H + (H.^2).*(2*a - 2*b - 2/h0))./kn + (12*b*mi0)./(H.*kn.^5) +...
                (12*b + 4/h0 - 2*mi0 + H.*(a*mi0 - 3*b*mi0 - (2*mi0)/h0 + ((-2 + a*h0 - 3*b*h0)*mi0)/h0) -...
                (4*sec(H.*kn))/h0)./kn.^3)+...
           hxx.*(1 - sec(H.*kn) + H.*(-a + b + 1/h0 + a*sec(H.*kn)) +...
                (2*b*mi0 + mi0/h0 + (-2*b + 2*b*sec(H.*kn))./H)./kn.^2 ) + ...
           Cn.*hx.*(-2 + sec(H.*kn) + H.*(2*a - 2*b - 2/h0 - a*sec(H.*kn)) + (-4*b*mi0 - (2*mi0)/h0 +...
           (4*b - 4*b*sec(H.*kn))./H)./kn.^2)+...
           hx.*knx.*( (H.*(-4*b - 2/h0 + 2*mi0) + (H.^2).*(-2*a*mi0 + 2*b*mi0 + (2*mi0)/h0))./kn + (-8*b*mi0 - (2*mi0)/h0 + (8*b - 8*b*sec(H.*kn))./H)./kn.^3);
        
C(n,n,:) = squeeze(A(n,n,:)).*(-Cnx - kn.^2) +... 
            (hx.^2).*( mi0/2 - (1/2)*H.*(kn.^2).*(1 + (mi0^2)./(kn.^2)) )+...
            (Cn.^2).*( H/2 + (-(mi0/2) + (H*mi0^2)/2)./kn.^2 )+...
            (knx.^2).*( -((H.^3)/6) + (-(mi0/4) + (H*mi0^2)/4)./kn.^4 +...
                         (-(H/4) + ((H.^2)*mi0)/2 - ((H.^3)*mi0^2)/6)./kn.^2  )+ ...
             knxx.*(H./(4*kn) + (mi0/4 - (H*mi0^2)/4)./kn.^3) +...
             hxx.*( -((mi0^2)./(2*kn.^2)) ) + ...
             -Cn.*hx +... 
             hx.*knx.*(-(((H.^2).*kn)/2) - (mi0^2)./(2*kn.^3) + (H*mi0 - ((H.^2).*mi0^2)/2)./kn)+...         
             + Cn.*knx.*(-(mi0./(4*kn.^3)) + (-(mi0/4) + (H*mi0^2)./4)./kn.^3 + (-(H/2) +...
                 (H*mi0^2)./(4.*kn.^2))./kn);
C(3,n,:) =  Cn.*knx.*(mi0./((k0.^2).*kn + kn.^3)) +...
           (knx.^2).*((4*mi0 + 2*H.*(k0.^2 - kn.^2 - 2*mi0^2))./(k0.^2 + kn.^2).^2)+...
            knxx.*((H.*kn.^2 - mi0 + H*mi0^2)./((k0.^2).*kn + kn.^3))+...
            knx.*((Cn.*(mi0 - 2*H.*(kn.^2 + mi0^2)))./(kn.*(k0.^2 + kn.^2)))+...
        hx.*knx.*((-2*(kn.^2)*mi0^2 + 2*(k0.^2).*(2*kn.^2 + mi0^2) -... 
                4*(k0.^2).*(kn.^2).* sec(H.*kn).*sech(H.*k0))./(kn.*(k0.^2 + kn.^2).^2))+...
       hxx.*((kn.^2 + mi0^2 - (kn.^2).*sec(H.*kn).*sech(k0.*H))./(k0.^2 + kn.^2))+... 
            hx.*((Cn.*(-2*(kn.^2 + mi0^2) - (k0.^2 - kn.^2).*sec(H.*kn).*sech(H.*k0)))./(k0.^2 + kn.^2));
           
C(n,3,:) =  C0.*k0x.*(-(mi0./(k0.^3 + (k0.*kn.^2)))) +...
           (k0x.^2).*((-4*mi0 + H.*(-2*k0.^2 + 2*kn.^2 + 4*mi0^2))./(k0.^2 + kn.^2).^2)+...
            k0xx.*((H.*k0.^2 + mi0 - H*mi0^2)./(k0.^3 + k0.*kn.^2))+...
            k0x.*(-(C0.*(mi0+2*H.*(k0.^2 - mi0^2)))./(k0.*(k0.^2 + kn.^2)))+...
        hx.*k0x.*((-2*(kn.^2)*mi0^2 + 2.*(k0.^2).*(2.*kn.^2 + mi0^2) -... 
              4*(k0.^2).*(kn.^2).*sec(H.*kn).*sech(H.*k0))./(k0.*(k0.^2 + kn.^2).^2))+...
       hxx.*((k0.^2 - mi0^2 - (k0.^2).*sec(H.*kn).*sech(H.*k0))./(k0.^2 + kn.^2))+... 
       hx.*((C0.*(-2*k0.^2 + 2*mi0^2 + (k0.^2 - kn.^2).*sec(H.*kn).*sech(H.*k0)))./(k0.^2 + kn.^2));

   
   for m = 4:Nm
    if m~=n
    km = k(:,m-2);
    C(m,n,:) =  Cn.*knx.*((2.*H.*kn.^2 - 2*mi0 + 2*H*mi0^2)./((km.^2).*kn - kn.^3)) +...
           (knx.^2).*(-((2.*(-2*mi0 + H.*(km.^2 + kn.^2 + 2.*mi0^2)))./(((km - kn).^2).*(km + kn).^2)))+...
            knxx.*((-mi0 + H.*(kn.^2 + mi0^2))./(-(km.^2).*kn + kn.^3))+...
        hx.*knx.*((-2*((kn.^2)*mi0^2 + (km.^2).*(2*kn.^2 + mi0^2)) +... 
                  4*(km.^2).*(kn.^2).*sec(H.*km).*sec(H.*kn))./(((km - kn).^2).*kn.*(km + kn).^2))+...
       hxx.*(-((kn.^2 + mi0^2 - (kn.^2).*sec(H.*km).*sec(H.*kn))./(km.^2 - kn.^2)))+... 
           Cn.*hx.*((2*kn.^2 + 2*mi0^2 - (km.^2 + kn.^2).*sec(H.*km).*sec(H.*kn))./((km - kn).*(km + kn)));
%     kmx = kx(:,m-2)';
%     kmxx = kxx(:,m-2)';
%      C(n,m,:) =  Cn.*kmx.*(-(mi0./((kn.^2).*km - km.^3))) +...
%            (kmx.^2).*(-((2.*(-2*mi0 + H.*(kn.^2 + km.^2 + 2.*mi0^2)))./(((kn - km).^2).*(kn + km).^2)))+...
%             kmxx.*((-mi0 + H.*(km.^2 + mi0^2))./(-(kn.^2).*km + km.^3))+...
%             kmx.*((Cn.*(mi0 - 2*H.*(km.^2 + mi0^2)))./(km.*(kn.^2 + km.^2)))+...
%         hx.*kmx.*((-2*((km.^2)*mi0^2 + (kn.^2).*(2*km.^2 + mi0^2)) +... 
%                   4*(kn.^2).*(km.^2).*sec(H.*kn).*sec(H.*km))./(((kn - km).^2).*km.*(kn + km).^2))+...
%        hxx.*(-((km.^2 + mi0^2 - (km.^2).*sec(H.*kn).*sec(H.*km))./(kn.^2 - km.^2)))+... 
%            Cn.*hx.*((2*km.^2 + 2*mi0^2 - (kn.^2 + km.^2).*sec(H.*kn).*sec(H.*km))./((kn - km).*(kn + km)));
   
           
    end
end

         
         
         

end

        
        
