function [ B ] = Bcoefs(  eta , h , etx , hx ,mi0 , h0 , k ,kx,  A,Nm)

a = (mi0*h0+1)/2/h0;
b = (mi0*h0-1)/2/h0;
H = eta+h;
Hx = etx+hx;

B(1,1,:) = (8*a/15)*(3*a*H-5).*H.*Hx + hx;

B(1,2,:) = ((-2*a - (2*b)/3)*H + ((4*a^2)/3 + (4*a*b)/15)*H.^2).*Hx+...
          (1+H*(-2*a+2*b+2/h0)+H.*H*(a^2-a*b-4*a/3/h0)).*hx;

B(2,1,:) = (-(8*a*H)./3 + a*(H.^2).*(-45+80*a*h0-32*b*h0)/30/h0).*Hx + ...
         (2*a*H + (1 - a*H).^2 + (a*(H.^2)*(40 - 60*a*h0 + 30*b*h0))./(30*h0)).*hx;
     
B(2,2,:) =  -( H.*( 60*a*h0 + 20*b*h0 + H.*(30*a + 15*b - 60*(a^2)*h0 + 12*(b^2)* h0))).*Hx/30/h0+...
         ((1 - a*H).^2 + (H*(1 + b*h0).*(H + 2*h0 - 2*a*H*h0 + b*H*h0))/h0^2).*hx;

k0 = k(:,1);
k0x = kx(:,1);
C0 = (mi0./k0).*(k0x.*H+k0.*Hx);

B(1,3,:) = k0x.*((2*H)./k0 - (12*a*mi0)./(H.*k0.^5) + (12*a - 2*mi0 - 4*a*H*mi0)./k0.^3) +...
                 C0.*((4*a - 2*mi0)./k0.^2 - (4*a*mi0)./(H.*k0.^4)) + ...
                 hx.*(2 + (4*a)./(H.*k0.^2) - (4*a*mi0)./k0.^2 + (1 - a*H + (2*(-2*a + H.*(-1 + a*H).*k0.^2))./(H.*k0.^2)).*sech(H.*k0));

B(3,1,:) = Hx.*(4*a./(H.*k0.^2) - 4*a*mi0./((H.^2).*k0.^4) - 4*a*mi0./k0.^2) +... 
             hx.*(-(4*a)./(H.*k0.^2) + 4*a*mi0./k0.^2 + (1 - a*H).*sech(H.*k0) +...
                (4*a*sech(H.*k0))./(H.*k0.^2));
            

B(3,3,:) = hx + k0x.*(H./(2*k0) - mi0./(2*k0.^3) + (H*mi0^2)./(2*k0.^3)) + ...  
                C0.*(-(mi0./k0.^2) - H.*(1 - (mi0^2)./k0.^2));
B(3,2,:) = Hx.*((4*b)./(H.*k0.^2) - (4*b*mi0)./((H.^2).* (k0.^4)) - (2*(a + b)*mi0)./k0.^2 ) +...
    hx.*(-((4*b)./(H.*k0.^2)) + (2*(1 + 2*b*h0)*mi0)./(h0.*k0.^2) + (1 - a*H + (4*b)./(H.*k0.^2)).*sech(H.*k0));

B(2,3,:) = k0x.*((2*H + (H.^2).*(-2*a + 2*b + 2/h0))./k0 - (12*b*mi0)./(H.*k0.^5) + ...
                (12*b + (4/h0) - 2*mi0 + H.*(2*a*mi0 - 6*b*mi0 - (4*mi0)/h0) -4*sech(H.*k0)./h0)./k0.^3)+ ...
           hx.*((2*(H + h0 - a*H*h0))/h0 + (2*b*(2 + (H.^2).*( k0.^2)))./(H.*k0.^2) -...
                (4*b*mi0)./k0.^2 - (2*mi0)./(h0.*k0.^2) + (-1 + a*H - (4*b)./(H.*k0.^2)).*sech(H.*k0))+...
                +C0.*((2.*(H + 2*b*H*h0))./(H.*h0.*k0.^2) - (4*b*mi0)./(H.*k0.^4) -...
                (2*b*H*mi0)./k0.^2 - (2*(H + h0 - a*H*h0).* mi0)./(h0*k0.^2) -...
                (2*sech(H.*k0))./(h0.*k0.^2));
    

for n=4:Nm
kn = k(:,n-2);  
knx = kx(:,n-2);
Cn = (mi0./kn).*(knx.*H+kn.*Hx);

B(1,n,:) = knx.*((2*H)./kn - (12*a*mi0)./(H.*kn.^5) + (-12*a + 2*mi0 + 4*a*H*mi0)./kn.^3) +...
                 Cn.*((-4*a + 2*mi0)./kn.^2 - (4*a*mi0)./(H.*kn.^4)) + ...
                 hx.*(2 - (4*a)./(H.*kn.^2) + (4*a*mi0)./kn.^2 + (1 - a*H + (2*(2*a + H.*(-1 + a*H).*kn.^2))./(H.*kn.^2)).*sec(H.*kn));
             
B(2,n,:) = knx.*((2*H + (H.^2).*(-2*a + 2*b + 2/h0))./kn - (12*b*mi0)./(H.*kn.^5) + ...
                (-12*b - (4/h0) + 2*mi0 + H.*(-2*a*mi0 + 6*b*mi0 + (4*mi0)/h0) +4*sec(H.*kn)./h0)./kn.^3)+ ...
           hx.*((-2*(-H - h0 + a*H*h0))/h0 + (2*b*(-2 + (H.^2).*( kn.^2)))./(H.*kn.^2) +...
                (4*b*mi0)./kn.^2 + (2*mi0)./(h0.*kn.^2) + (-1 + a*H + (4*b)./(H.*kn.^2)).*sec(H.*kn))+...
           +Cn.*(-(2.*(H + 2*b*H*h0))./(H.*h0.*kn.^2) - (4*b*mi0)./(H.*kn.^4) +...
                (2*b*H*mi0)./kn.^2 + (2*(H + h0 - a*H*h0).* mi0)./(h0*kn.^2) +...
                (2*sec(H.*kn))./(h0.*kn.^2)); 

Ksq = (k0.^2+kn.^2);
B(3,n,:) = knx.* ((2*H.*kn)./Ksq - (4.*kn*mi0)./Ksq.^2 + (2*(-k0.^2 + kn.^2)* mi0)./(kn.*Ksq.^2) + (2*H*mi0^2)./(kn.*Ksq))+...
                +hx.*((2*kn.^2)./Ksq + (2*mi0^2)./Ksq + (1 - (2*kn.^2)./Ksq).*sec(H.*kn).*sech(H.*k0));

B(n,1,:) = Hx.*(-4*a./(H.*kn.^2) - 4*a*mi0./((H.^2).*kn.^4) + 4*a*mi0./kn.^2) +... 
             hx.*((4*a)./(H.*kn.^2) - 4*a*mi0./kn.^2 + (1 - a*H).*sec(H.*kn) -...
                (4*a*sec(H.*kn))./(H.*kn.^2));
            
B(n,2,:) = Hx.*(-(4*b)./(H.*kn.^2) - (4*b*mi0)./((H.^2).* (kn.^4)) + (2*(a + b)*mi0)./kn.^2 ) +...
                hx.*(((4*b)./(H.*kn.^2)) -((4*b*mi0)./kn.^2) - (2*mi0)./(h0*kn.^2) + (1 - a*H  -(4*b)./(H.*kn.^2)).*sec(H.*kn));
            
B(n,3,:) = 2*k0x.*(k0.*(H.*Ksq + 2*mi0) + (mi0*(-k0.^2 + kn.^2 - H.*Ksq*mi0))./k0)./Ksq.^2 + ...
            hx.*((2*k0.^2)./Ksq - (2*mi0^2)./Ksq + (1 - (2*k0.^2)./Ksq).*sec(H.*kn).*sech(H.*k0));
B(n,n,:) = -2*Cn.*squeeze(A(n,n,:))+knx.*(H./2./kn + (mi0/2 - 0.5*H*mi0^2)./kn.^3) + hx;

for m =4:Nm
    if m~=n
    
    km = k(:,m-2); 
    kmx = kx(:,m-2); 
B(n,m,:) = 2*kmx.*(-mi0+H.*(km.^2+mi0^2))./km./(km.^2-kn.^2) + ...
   -hx.*(-2*(km.^2+mi0^2)+(km.^2+kn.^2).*sec(H.*km).*sec(H.*kn))./(km.^2-kn.^2);
B(m,n,:) = 2*knx.*(-mi0+H.*(kn.^2+mi0^2))./kn./(kn.^2-km.^2) + ...
   -hx.*(-2*(kn.^2+mi0^2)+(kn.^2+km.^2).*sec(H.*kn).*sec(H.*km))./(kn.^2-km.^2);
% B(n,m,:) = kmx.*(-mi0+H.*(km.^2+mi0^2))./km./(km.^2-kn.^2) + ...
%     km.*hx.*(-0.5).*(-2*mi0*mi0./(kn.^2-km.^2) + 2*km./(kn.^2-km.^2) - 2*mi0*sqrt(1+(mi0^2)./km.^2).*sqrt(1+(mi0^2)./kn.^2));
    end
end

end


